{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-gear me-2"></i>{{ t('config') }}</h4>
    <div>
        <button class="btn btn-success btn-sm" onclick="applyConfig()">
            <i class="bi bi-check-circle me-1"></i>{{ t('button.apply_reload') }}
        </button>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="users-btn" data-bs-toggle="tab" data-bs-target="#users-tab">
            <i class="bi bi-people me-1"></i>{{ t('section.users') }}
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="gateways-btn" data-bs-toggle="tab" data-bs-target="#gateways-tab">
            <i class="bi bi-diagram-3 me-1"></i>{{ t('section.gateways') }}
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="routes-btn" data-bs-toggle="tab" data-bs-target="#routes-tab">
            <i class="bi bi-signpost-2 me-1"></i>{{ t('section.routes') }}
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- Users Tab -->
    <div class="tab-pane fade show active" id="users-tab">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-person-badge me-2"></i>{{ t('section.sip_users') }}</span>
                <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                    <i class="bi bi-plus-lg me-1"></i>{{ t('modal.add_user') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="users-table">
                        <thead>
                            <tr>
                                <th>{{ t('auth.username') }}</th>
                                <th>{{ t('field.extension') }}</th>
                                <th>{{ t('status.online') }}</th>
                                <th width="120">{{ t('field.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-shield-check me-2"></i>{{ t('section.acl_users') }}</span>
                <button class="btn btn-primary btn-sm" onclick="showAddAclUserModal()">
                    <i class="bi bi-plus-lg me-1"></i>{{ t('modal.add_acl_user') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="acl-users-table">
                        <thead>
                            <tr>
                                <th>{{ t('auth.username') }}</th>
                                <th>{{ t('field.ip_address') }}</th>
                                <th>{{ t('field.extension') }}</th>
                                <th>{{ t('field.caller_id') }}</th>
                                <th width="120">{{ t('field.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Gateways Tab -->
    <div class="tab-pane fade" id="gateways-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-diagram-3 me-2"></i>{{ t('gateway.sip_gateways') }}</span>
                <button class="btn btn-primary btn-sm" onclick="showAddGatewayModal()">
                    <i class="bi bi-plus-lg me-1"></i>{{ t('gateway.add_gateway') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="gateways-table">
                        <thead>
                            <tr>
                                <th>{{ t('field.name') }}</th>
                                <th>{{ t('field.host') }}</th>
                                <th>{{ t('field.port') }}</th>
                                <th>{{ t('auth.username') }}</th>
                                <th>{{ t('field.register') }}</th>
                                <th>{{ t('status.online') }}</th>
                                <th width="120">{{ t('field.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Routes Tab -->
    <div class="tab-pane fade" id="routes-tab">
        <!-- Default Routes -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-house me-2"></i>{{ t('section.default_routes') }}
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">{{ t('config.default_gateway') }}</label>
                        <select class="form-select" id="default-gateway">
                            <option value="">{{ t('modal.select') }}</option>
                        </select>
                        <small class="text-muted">{{ t('config.outbound_calls_via') }}</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ t('config.default_extension') }}</label>
                        <input type="text" class="form-control" id="default-extension" placeholder="1001">
                        <small class="text-muted">{{ t('config.inbound_default') }}</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ t('system.outbound_caller_id') }}</label>
                        <input type="text" class="form-control" id="default-outbound-caller-id" placeholder="+4932221803989">
                        <small class="text-muted">{{ t('config.caller_id_desc') }}</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ t('system.default_country') }}</label>
                        <input type="text" class="form-control" id="default-country-code" value="49" maxlength="4">
                        <small class="text-muted">{{ t('config.country_code_desc') }}</small>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="saveDefaultRoutes()">
                    <i class="bi bi-save me-1"></i>{{ t('button.save_defaults') }}
                </button>
            </div>
        </div>

        <!-- Inbound Routes -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-telephone-inbound me-2"></i>{{ t('route.inbound_routes') }}</span>
                <button class="btn btn-primary btn-sm" onclick="showAddInboundRouteModal()">
                    <i class="bi bi-plus-lg me-1"></i>{{ t('route.add_route') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="inbound-routes-table">
                        <thead>
                            <tr>
                                <th>{{ t('route.did_number') }}</th>
                                <th>{{ t('field.destination') }}</th>
                                <th>{{ t('field.type') }}</th>
                                <th width="100">{{ t('field.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- User Routes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-person-lines-fill me-2"></i>{{ t('section.user_outbound_routes') }}</span>
                <button class="btn btn-primary btn-sm" onclick="showAddUserRouteModal()">
                    <i class="bi bi-plus-lg me-1"></i>{{ t('route.add_route') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="user-routes-table">
                        <thead>
                            <tr>
                                <th>{{ t('field.user') }}</th>
                                <th>{{ t('field.gateway') }}</th>
                                <th width="100">{{ t('field.actions') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">{{ t('modal.add_user') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user-edit-mode">
                <div class="mb-3">
                    <label class="form-label">{{ t('auth.username') }}</label>
                    <input type="text" class="form-control" id="user-username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('auth.password') }}</label>
                    <input type="password" class="form-control" id="user-password" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.extension') }}</label>
                    <input type="text" class="form-control" id="user-extension" placeholder="1001" required>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="user-enabled" checked>
                    <label class="form-check-label">{{ t('status.enabled') }}</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('button.cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">{{ t('button.save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- ACL User Modal -->
<div class="modal fade" id="aclUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aclUserModalTitle">{{ t('modal.add_acl_user') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="acl-user-edit-mode">
                <div class="mb-3">
                    <label class="form-label">{{ t('auth.username') }}</label>
                    <input type="text" class="form-control" id="acl-user-username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.ip_address') }}</label>
                    <input type="text" class="form-control" id="acl-user-ip" placeholder="192.168.1.100" required>
                    <small class="text-muted">{{ t('modal.multiple_ips_hint') }}</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.extension') }}</label>
                    <input type="text" class="form-control" id="acl-user-extension" placeholder="9000">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.caller_id') }}</label>
                    <input type="text" class="form-control" id="acl-user-callerid" placeholder="+4932221803986">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('button.cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveAclUser()">{{ t('button.save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Gateway Modal -->
<div class="modal fade" id="gatewayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gatewayModalTitle">{{ t('modal.add_gateway') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="gateway-edit-mode">
                <div class="mb-3">
                    <label class="form-label">{{ t('field.name') }}</label>
                    <input type="text" class="form-control" id="gateway-name" placeholder="provider" required>
                </div>
                <div class="row mb-3">
                    <div class="col-8">
                        <label class="form-label">{{ t('field.host') }}</label>
                        <input type="text" class="form-control" id="gateway-host" placeholder="sip.provider.com" required>
                    </div>
                    <div class="col-4">
                        <label class="form-label">{{ t('field.port') }}</label>
                        <input type="number" class="form-control" id="gateway-port" value="5060">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('auth.username') }}</label>
                    <input type="text" class="form-control" id="gateway-username">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('auth.password') }}</label>
                    <input type="password" class="form-control" id="gateway-password">
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('gateway.auth_username') }}</label>
                    <input type="text" class="form-control" id="gateway-auth-username">
                    <small class="text-muted">{{ t('gateway.auth_username_hint') }}</small>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">{{ t('field.transport') }}</label>
                        <select class="form-select" id="gateway-transport">
                            <option value="udp">UDP</option>
                            <option value="tcp">TCP</option>
                            <option value="tls">TLS</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <div class="form-check mt-4">
                            <input type="checkbox" class="form-check-input" id="gateway-register" checked>
                            <label class="form-check-label">{{ t('field.register') }}</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('button.cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveGateway()">{{ t('button.save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Inbound Route Modal -->
<div class="modal fade" id="inboundRouteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('route.add_inbound') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('route.did_number') }}</label>
                    <input type="text" class="form-control" id="inbound-did" placeholder="+4930221803986" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('route.dest_type') }}</label>
                    <select class="form-select" id="inbound-dest-type">
                        <option value="extension">{{ t('field.extension') }}</option>
                        <option value="gateway">{{ t('field.gateway') }}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.destination') }}</label>
                    <input type="text" class="form-control" id="inbound-destination" placeholder="1001 or gateway_name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('button.cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveInboundRoute()">{{ t('button.save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- User Route Modal -->
<div class="modal fade" id="userRouteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ t('route.add_user_route') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ t('field.user') }}</label>
                    <select class="form-select" id="user-route-user"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ t('field.gateway') }}</label>
                    <select class="form-select" id="user-route-gateway"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('button.cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveUserRoute()">{{ t('button.save') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast" class="toast" role="alert">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2" id="toast-icon"></i>
            <strong class="me-auto" id="toast-title">{{ t('modal.notification') }}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/manage.js') }}"></script>
{% endblock %}
