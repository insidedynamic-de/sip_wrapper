{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">{{ t('users') }}</h4>
    <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise me-1"></i>{{ t('reload') }}
    </button>
</div>

<!-- User Cards -->
{% if users %}
<div class="row g-3 mb-4">
    {% for user in users %}
    <div class="col-md-6 col-lg-4" data-user="{{ user.username }}">
        <div class="card h-100 {% if user.online %}border-success{% else %}border-secondary{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center {% if user.online %}bg-success bg-opacity-10{% else %}bg-secondary bg-opacity-10{% endif %}">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle fs-4 me-2 {% if user.online %}text-success{% else %}text-secondary{% endif %}"></i>
                    <strong>{{ user.username }}</strong>
                </div>
                <span class="badge {% if user.online %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if user.online %}
                        <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>{{ t('online') }}
                    {% else %}
                        <i class="bi bi-circle me-1" style="font-size: 0.5rem;"></i>{{ t('offline') }}
                    {% endif %}
                </span>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">{{ t('extension') }}:</small>
                    <span class="ms-2 badge bg-primary">{{ user.extension or '-' }}</span>
                </div>

                <div class="mb-2">
                    <small class="text-muted">Typ:</small>
                    <span class="ms-2">
                        {% if user.type == 'auth' %}
                            <i class="bi bi-key text-warning"></i> Auth
                        {% else %}
                            <i class="bi bi-shield-check text-info"></i> ACL
                        {% endif %}
                    </span>
                </div>

                {% if user.ip %}
                <div class="mb-2">
                    <small class="text-muted">{{ t('ip_address') }}:</small>
                    <code class="ms-2">{{ user.ip }}</code>
                </div>
                {% endif %}

                {% if user.online %}
                <hr class="my-2">
                <div class="small">
                    {% if user.contact %}
                    <div class="text-truncate mb-1" title="{{ user.contact }}">
                        <i class="bi bi-telephone text-muted me-1"></i>
                        <span class="text-muted">{{ user.contact[:40] }}{% if user.contact|length > 40 %}...{% endif %}</span>
                    </div>
                    {% endif %}
                    {% if user.agent %}
                    <div class="text-truncate" title="{{ user.agent }}">
                        <i class="bi bi-phone text-muted me-1"></i>
                        <span class="text-muted">{{ user.agent[:35] }}{% if user.agent|length > 35 %}...{% endif %}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <small class="text-muted">
                    {% if user.online %}
                        <i class="bi bi-check-circle-fill text-success me-1"></i>{{ t('registered') }}
                    {% else %}
                        <i class="bi bi-dash-circle text-secondary me-1"></i>{{ t('not_registered') }}
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    Keine Benutzer konfiguriert. Benutzer werden aus der <code>USERS</code> oder <code>ACL_USERS</code> Umgebungsvariable gelesen.
</div>
{% endif %}

<!-- Additional Registrations (users not in config) -->
{% if registrations %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-people me-2"></i>{{ t('user_registrations') }} (Live)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>{{ t('contact') }}</th>
                        <th>{{ t('user_agent') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reg in registrations %}
                    <tr>
                        <td><strong>{{ reg.user or '-' }}</strong></td>
                        <td><small class="text-muted">{{ reg.contact or '-' }}</small></td>
                        <td><small>{{ reg.agent or '-' }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Configuration Help -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-info-circle me-2"></i>Benutzer Konfiguration
    </div>
    <div class="card-body">
        <h6 class="mb-3"><i class="bi bi-key text-warning me-2"></i>Authentifizierte Benutzer (USERS)</h6>
        <pre class="bg-dark text-light p-3 rounded"><code>USERS=alice:SecretPass123:1001,bob:SecretPass456:1002</code></pre>
        <p class="text-muted small">Format: <code>username:password:extension</code></p>

        <hr>

        <h6 class="mb-3"><i class="bi bi-shield-check text-info me-2"></i>IP-basierte Benutzer (ACL_USERS)</h6>
        <pre class="bg-dark text-light p-3 rounded"><code>ACL_USERS=vapi:192.168.1.100|10.0.0.5:9000:+4932221803986</code></pre>
        <p class="text-muted small mb-0">Format: <code>username:ip|ip2:extension:callerid</code></p>
    </div>
</div>
{% endblock %}
