################################################################################
# FreeSWITCH for Coolify - Debian Version (WORKING!)
# Использует Debian и устанавливает FreeSWITCH + provision
#
# ПРОВЕРЕНО: Работает в Coolify без проблем
#
# ИСПОЛЬЗОВАНИЕ:
# 1. Coolify → Docker Compose file: docker-compose.coolify-debian.yml
# 2. Set ENV variables
# 3. Deploy
################################################################################

version: '3.9'

services:
  freeswitch:
    # Debian base image
    image: debian:bookworm-slim

    container_name: freeswitch

    # Install FreeSWITCH and run provision
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e

        # Validation function
        validate_env() {
          echo "[$$(date)] Validating environment variables..."
          local missing=""
          [ -z "$FS_DOMAIN" ] && missing="$$missing FS_DOMAIN"
          [ -z "$EXTERNAL_SIP_IP" ] && missing="$$missing EXTERNAL_SIP_IP"
          [ -z "$EXTERNAL_RTP_IP" ] && missing="$$missing EXTERNAL_RTP_IP"
          [ -z "$USERS" ] && missing="$$missing USERS"
          [ -z "$GATEWAYS" ] && missing="$$missing GATEWAYS"

          if [ -n "$$missing" ]; then
            echo "ERROR: Missing required environment variables:$$missing"
            echo "Please set these variables in Coolify UI before deployment."
            exit 1
          fi

          # Check for placeholder values and auto-detect IP if needed
          if [ "$EXTERNAL_SIP_IP" = "your-server-ip" ] || [ "$EXTERNAL_RTP_IP" = "your-server-ip" ]; then
            echo "WARNING: Placeholder IP detected. Auto-detecting public IP..."

            # Try to detect public IP
            DETECTED_IP=$$(curl -s --max-time 5 ifconfig.me 2>/dev/null || curl -s --max-time 5 ipinfo.io/ip 2>/dev/null || curl -s --max-time 5 icanhazip.com 2>/dev/null || echo "")

            if [ -n "$$DETECTED_IP" ]; then
              echo "✓ Auto-detected IP: $$DETECTED_IP"
              export EXTERNAL_SIP_IP="$$DETECTED_IP"
              export EXTERNAL_RTP_IP="$$DETECTED_IP"
            else
              echo "ERROR: Could not auto-detect IP. Please set EXTERNAL_SIP_IP and EXTERNAL_RTP_IP manually."
              exit 1
            fi
          fi

          echo "[$$(date)] Environment validation passed."
          echo "Using IPs: EXTERNAL_SIP_IP=$$EXTERNAL_SIP_IP, EXTERNAL_RTP_IP=$$EXTERNAL_RTP_IP"
        }

        echo "[$$(date)] Starting FreeSWITCH deployment..."

        # Validate ENV variables first
        validate_env

        echo "[$$(date)] Installing dependencies..."
        apt-get update -qq || { echo "ERROR: apt-get update failed"; exit 1; }

        # Install in stages for better error tracking
        echo "[$$(date)] Installing essential tools..."
        apt-get install -y -qq --no-install-recommends curl wget gnupg2 ca-certificates || { echo "ERROR: Failed to install essential tools"; exit 1; }

        echo "[$$(date)] Installing additional tools..."
        apt-get install -y -qq --no-install-recommends lsb-release procps || { echo "ERROR: Failed to install additional tools"; exit 1; }

        echo "[$$(date)] Adding SignalWire repository..."
        wget -qO- https://files.freeswitch.org/repo/deb/debian-release/fsstretch-archive-keyring.asc 2>/dev/null | \
          gpg --dearmor -o /usr/share/keyrings/signalwire-freeswitch-repo.gpg 2>/dev/null || { echo "ERROR: Failed to add GPG key"; exit 1; }

        echo "deb [signed-by=/usr/share/keyrings/signalwire-freeswitch-repo.gpg] https://files.freeswitch.org/repo/deb/debian-release/ $$(lsb_release -sc) main" \
          > /etc/apt/sources.list.d/freeswitch.list || { echo "ERROR: Failed to add FreeSWITCH repository"; exit 1; }

        echo "[$$(date)] Installing FreeSWITCH packages..."
        apt-get update -qq || { echo "ERROR: apt-get update failed after adding repo"; exit 1; }
        apt-get install -y -qq --no-install-recommends \
          freeswitch-meta-bare \
          freeswitch-mod-commands \
          freeswitch-mod-console \
          freeswitch-mod-logfile \
          freeswitch-mod-event-socket \
          freeswitch-mod-sofia \
          freeswitch-mod-dialplan-xml \
          freeswitch-mod-dptools \
          freeswitch-mod-db \
          freeswitch-mod-sndfile \
          freeswitch-mod-native-file \
          freeswitch-mod-tone-stream || { echo "ERROR: Failed to install FreeSWITCH packages"; exit 1; }

        rm -rf /var/lib/apt/lists/*
        echo "[$$(date)] FreeSWITCH installation completed."

        echo "[$$(date)] Cleaning default config..."
        if [ -d /etc/freeswitch ]; then
          cp -a /etc/freeswitch /etc/freeswitch.orig 2>/dev/null || true
          find /etc/freeswitch/dialplan -type f -name "*.xml" -delete 2>/dev/null || true
          find /etc/freeswitch/directory -type f -name "*.xml" -delete 2>/dev/null || true
          rm -f /etc/freeswitch/sip_profiles/*.xml 2>/dev/null || true
          mkdir -p /etc/freeswitch/{dialplan/{default,public},directory/default,sip_profiles/{internal,external}}
          echo "[$$(date)] Default config cleaned."
        else
          echo "WARNING: /etc/freeswitch directory not found"
        fi

        echo "[$$(date)] Downloading provision script..."
        curl -fsSL https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/provision.sh -o /tmp/provision.sh || { echo "ERROR: Failed to download provision.sh"; exit 1; }
        chmod +x /tmp/provision.sh

        echo "[$$(date)] Running provision script..."
        bash /tmp/provision.sh || { echo "ERROR: Provision script failed"; exit 1; }
        echo "[$$(date)] Provision completed successfully."

        echo "[$$(date)] Starting FreeSWITCH..."
        echo "[$$(date)] Command: /usr/bin/freeswitch -nonat -nf -nc"
        exec /usr/bin/freeswitch -nonat -nf -nc

    # Environment variables
    environment:
      # REQUIRED
      FS_DOMAIN: ${FS_DOMAIN}
      EXTERNAL_SIP_IP: ${EXTERNAL_SIP_IP}
      EXTERNAL_RTP_IP: ${EXTERNAL_RTP_IP}
      USERS: ${USERS}
      GATEWAYS: ${GATEWAYS}

      # ROUTING
      DEFAULT_GATEWAY: ${DEFAULT_GATEWAY:-}
      DEFAULT_EXTENSION: ${DEFAULT_EXTENSION:-}
      OUTBOUND_ROUTES: ${OUTBOUND_ROUTES:-}
      INBOUND_ROUTES: ${INBOUND_ROUTES:-}

      # OPTIONAL
      ACL_USERS: ${ACL_USERS:-}
      INTERNAL_SIP_PORT: ${INTERNAL_SIP_PORT:-5060}
      EXTERNAL_SIP_PORT: ${EXTERNAL_SIP_PORT:-5080}
      RTP_START_PORT: ${RTP_START_PORT:-16384}
      RTP_END_PORT: ${RTP_END_PORT:-32768}
      CODEC_PREFS: ${CODEC_PREFS:-PCMU,PCMA,G729,opus}
      SIP_DEBUG: ${SIP_DEBUG:-0}
      SIP_TRACE: ${SIP_TRACE:-no}

    # Host network
    network_mode: host

    # Restart policy
    restart: unless-stopped

    # Volumes
    volumes:
      - freeswitch_backups:/var/backups/freeswitch

    # Health check
    healthcheck:
      test: ["CMD", "bash", "-c", "pgrep -x freeswitch > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

volumes:
  freeswitch_backups:
    driver: local

################################################################################
# ENV VARIABLES FOR COOLIFY
################################################################################
#
# FS_DOMAIN=apps.linkify.cloud
# EXTERNAL_SIP_IP=your-server-ip
# EXTERNAL_RTP_IP=your-server-ip
# USERS=exampleuser:examplepass:1001
# GATEWAYS=provider:fpbx.de:5060:777z9uovpu:4UMtPyXw8Qss:true:udp
# DEFAULT_GATEWAY=provider
# DEFAULT_EXTENSION=1001
#
################################################################################
