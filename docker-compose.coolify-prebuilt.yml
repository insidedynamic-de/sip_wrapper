################################################################################
# InsideDynamic Wrapper for Coolify - Pre-built Image Version
# Использует готовый Docker образ вместо установки из репозитория
#
# ИСПОЛЬЗУЙТЕ ЭТУ ВЕРСИЮ ЕСЛИ:
# - Проблемы с загрузкой GPG ключа SignalWire
# - Firewall блокирует доступ к files.freeswitch.org
# - Нужен быстрый запуск без компиляции
#
# COOLIFY HTTPS (Port 443):
# 1. В Coolify настройте Service -> Proxy -> Port: 8888
# 2. Добавьте домен в Coolify (например: admin.example.com)
# 3. Coolify автоматически выпустит SSL сертификат
# 4. Admin Portal будет доступен: https://admin.example.com
################################################################################

version: '3.9'

services:
  insidedynamic-wrapper:
    # Используем готовый образ FreeSWITCH
    image: ghcr.io/patrickbaus/freeswitch-docker:latest

    container_name: insidedynamic-wrapper

    # Coolify Labels for HTTPS (port 443)
    labels:
      - coolify.managed=true
      - coolify.proxy.port=8888

    # Run provision and start (using /bin/sh for Alpine compatibility)
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e

        # Enable verbose mode if DEBUG=true
        if [ "$DEBUG" = "true" ]; then
          set -x
        fi

        # Show banner
        echo ""
        echo "================================================================================"
        if [ -n "$CLIENT_NAME" ]; then
          echo "  InsideDynamic Wrapper - ($LICENSE_KEY) für $CLIENT_NAME"
        else
          echo "  InsideDynamic Wrapper - ($LICENSE_KEY)"
        fi
        echo "================================================================================"
        echo "  https://insidedynamic.de/wrapper"
        echo "  (c) 2025 InsideDynamic GmbH - Mannheim, Germany"
        echo "================================================================================"
        echo ""

        # Validate ENV
        echo "[STEP 1/8] Validating environment variables..."
        if [ -z "$FS_DOMAIN" ] || [ -z "$EXTERNAL_SIP_IP" ] || [ -z "$EXTERNAL_RTP_IP" ]; then
          echo "ERROR: Missing required environment variables!"
          echo "Required: FS_DOMAIN, EXTERNAL_SIP_IP, EXTERNAL_RTP_IP"
          exit 1
        fi

        # Auto-detect IP if placeholder
        if [ "$EXTERNAL_SIP_IP" = "your-server-ip" ] || [ "$EXTERNAL_RTP_IP" = "your-server-ip" ]; then
          echo "Auto-detecting public IP..."
          DETECTED_IP=$$(wget -qO- --timeout=5 ifconfig.me 2>/dev/null || wget -qO- --timeout=5 ipinfo.io/ip 2>/dev/null || echo "")
          if [ -n "$$DETECTED_IP" ]; then
            echo "✓ Auto-detected IP: $$DETECTED_IP"
            export EXTERNAL_SIP_IP="$$DETECTED_IP"
            export EXTERNAL_RTP_IP="$$DETECTED_IP"
          else
            echo "ERROR: Could not auto-detect IP"
            exit 1
          fi
        fi

        echo "✓ Environment validated"
        echo "  EXTERNAL_SIP_IP: $EXTERNAL_SIP_IP"
        echo "  EXTERNAL_RTP_IP: $EXTERNAL_RTP_IP"

        # Check if FreeSWITCH is installed
        echo ""
        echo "[STEP 2/8] Checking FreeSWITCH installation..."
        if [ -x /usr/bin/freeswitch ]; then
          echo "✓ FreeSWITCH found"
        else
          echo "ERROR: FreeSWITCH not found in this image!"
          exit 1
        fi

        # Clean default config
        echo ""
        echo "[STEP 3/8] Preparing configuration..."
        if [ -d /etc/freeswitch ]; then
          find /etc/freeswitch/dialplan -type f -name "*.xml" -delete 2>/dev/null || true
          find /etc/freeswitch/directory -type f -name "*.xml" -delete 2>/dev/null || true
          rm -f /etc/freeswitch/sip_profiles/*.xml 2>/dev/null || true
          mkdir -p /etc/freeswitch/dialplan/default /etc/freeswitch/dialplan/public
          mkdir -p /etc/freeswitch/directory/default
          mkdir -p /etc/freeswitch/sip_profiles/internal /etc/freeswitch/sip_profiles/external
          echo "✓ Config directories prepared"
        fi

        # Install bash and python (needed for provision script and admin portal)
        echo ""
        echo "[STEP 4/8] Installing dependencies..."
        apk add --no-cache bash python3 py3-pip >/dev/null 2>&1 || {
          echo "Trying with apt-get..."
          apt-get update -qq && apt-get install -y -qq bash python3 python3-pip python3-venv || {
            echo "ERROR: Cannot install dependencies"
            exit 1
          }
        }

        # Create /bin/bash symlink if it doesn't exist
        if [ ! -e /bin/bash ] && [ -x /usr/bin/bash ]; then
          ln -sf /usr/bin/bash /bin/bash
        fi
        echo "✓ Dependencies installed"

        # Download and run provision
        echo ""
        echo "[STEP 5/8] Running provision script..."
        wget --no-cache -qO /tmp/provision.sh https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/provision.sh
        chmod +x /tmp/provision.sh

        if [ "$DEBUG" = "true" ]; then
          /bin/bash -x /tmp/provision.sh 2>&1 || { echo "ERROR: Provision failed"; exit 1; }
        else
          /bin/bash /tmp/provision.sh || { echo "ERROR: Provision failed"; exit 1; }
        fi
        echo "✓ Provision completed"

        # Install Admin Portal
        echo ""
        echo "[STEP 6/8] Installing Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ]; then
          mkdir -p /opt/admin/templates

          # Download admin files
          wget --no-cache -qO /opt/admin/app.py https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/app.py
          wget --no-cache -qO /opt/admin/requirements.txt https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/requirements.txt
          wget --no-cache -qO /opt/admin/templates/base.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/base.html
          wget --no-cache -qO /opt/admin/templates/login.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/login.html
          wget --no-cache -qO /opt/admin/templates/dashboard.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/dashboard.html
          wget --no-cache -qO /opt/admin/templates/config.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/config.html
          wget --no-cache -qO /opt/admin/templates/gateways.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/gateways.html
          wget --no-cache -qO /opt/admin/templates/users.html https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin/templates/users.html

          # Install Python dependencies (use venv for Alpine)
          python3 -m venv /opt/admin/venv
          /opt/admin/venv/bin/pip install --no-cache-dir -q flask gunicorn

          echo "✓ Admin Portal installed"
        else
          echo "✓ Admin Portal skipped (SKIP_ADMIN=true)"
        fi

        # Start Admin Portal
        echo ""
        echo "[STEP 7/8] Starting Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ] && [ -f /opt/admin/app.py ]; then
          cd /opt/admin
          /opt/admin/venv/bin/python app.py &
          ADMIN_PID=$$!
          echo "✓ Admin Portal started on port $ADMIN_PORT (PID: $$ADMIN_PID)"
        else
          echo "✓ Admin Portal not started"
        fi

        # Start FreeSWITCH
        echo ""
        echo "[STEP 8/8] Starting FreeSWITCH..."
        echo "=========================================="
        echo "FreeSWITCH is starting..."
        echo "Admin Portal: http://localhost:$ADMIN_PORT"
        if [ -n "$SERVICE_FQDN_ADMIN_8888" ]; then
          echo "Admin Portal (HTTPS): https://$SERVICE_FQDN_ADMIN_8888"
        fi
        echo "=========================================="
        exec /usr/bin/freeswitch -nonat -nf -nc

    environment:
      # LICENSE
      LICENSE_KEY: ${LICENSE_KEY:-UNLICENSED}
      CLIENT_NAME: ${CLIENT_NAME:-}

      # REQUIRED
      FS_DOMAIN: ${FS_DOMAIN}
      EXTERNAL_SIP_IP: ${EXTERNAL_SIP_IP}
      EXTERNAL_RTP_IP: ${EXTERNAL_RTP_IP}
      USERS: ${USERS:-}
      GATEWAYS: ${GATEWAYS:-}

      # ROUTING
      DEFAULT_GATEWAY: ${DEFAULT_GATEWAY:-}
      DEFAULT_EXTENSION: ${DEFAULT_EXTENSION:-}
      OUTBOUND_ROUTES: ${OUTBOUND_ROUTES:-}
      INBOUND_ROUTES: ${INBOUND_ROUTES:-}

      # OPTIONAL
      ACL_USERS: ${ACL_USERS:-}
      INTERNAL_SIP_PORT: ${INTERNAL_SIP_PORT:-5060}
      EXTERNAL_SIP_PORT: ${EXTERNAL_SIP_PORT:-5080}
      RTP_START_PORT: ${RTP_START_PORT:-16384}
      RTP_END_PORT: ${RTP_END_PORT:-32768}
      CODEC_PREFS: ${CODEC_PREFS:-PCMU,PCMA,G729,opus}
      OUTBOUND_CODEC_PREFS: ${OUTBOUND_CODEC_PREFS:-}
      SIP_USER_AGENT: ${SIP_USER_AGENT:-InsideDynamic-Wrapper}
      SIP_DEBUG: ${SIP_DEBUG:-0}
      SIP_TRACE: ${SIP_TRACE:-no}

      # ADMIN PORTAL
      ADMIN_PORT: ${ADMIN_PORT:-8888}
      ADMIN_USER: ${ADMIN_USER:-admin}
      ADMIN_PASS: ${ADMIN_PASS:-admin}
      SKIP_ADMIN: ${SKIP_ADMIN:-false}
      SERVICE_FQDN_ADMIN_8888: ${SERVICE_FQDN_ADMIN_8888:-}

      # DEBUG
      DEBUG: ${DEBUG:-false}

    network_mode: host
    restart: unless-stopped

    volumes:
      - freeswitch_backups:/var/backups/freeswitch

    healthcheck:
      test: ["CMD", "sh", "-c", "pgrep -x freeswitch > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

volumes:
  freeswitch_backups:
    driver: local

################################################################################
# ПРЕИМУЩЕСТВА ЭТОЙ ВЕРСИИ:
################################################################################
# ✅ Не нужно скачивать GPG ключи
# ✅ Не нужно устанавливать пакеты из SignalWire репозитория
# ✅ Быстрый запуск (образ уже скомпилирован)
# ✅ Меньше точек отказа
# ✅ Работает даже если files.freeswitch.org недоступен
# ✅ Admin Portal на порту 8888
#
# ИСПОЛЬЗОВАНИЕ В COOLIFY:
# 1. Docker Compose file: docker-compose.coolify-prebuilt.yml
# 2. Установите ENV переменные
# 3. Deploy
#
# ADMIN PORTAL (HTTPS через Coolify):
# 1. Service Name: insidedynamic-wrapper
# 2. В Coolify: Service -> Proxy -> Port: 8888
# 3. Добавьте домен (например: admin.example.com)
# 4. URL: https://admin.example.com (port 443 автоматически)
# 5. Login: admin / admin (или ADMIN_USER / ADMIN_PASS)
#
# Документация: https://insidedynamic.de/wrapper
################################################################################
