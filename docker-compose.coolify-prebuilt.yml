################################################################################
# InsideDynamic Wrapper for Coolify - Pre-built Image Version
# Использует готовый Docker образ вместо установки из репозитория
#
# ИСПОЛЬЗУЙТЕ ЭТУ ВЕРСИЮ ЕСЛИ:
# - Проблемы с загрузкой GPG ключа SignalWire
# - Firewall блокирует доступ к files.freeswitch.org
# - Нужен быстрый запуск без компиляции
#
# COOLIFY HTTPS (Port 443):
# 1. В Coolify настройте Service -> Proxy -> Port: 8888
# 2. Добавьте домен в Coolify (например: admin.example.com)
# 3. Coolify автоматически выпустит SSL сертификат
# 4. Admin Portal будет доступен: https://admin.example.com
################################################################################

version: '3.9'

services:
  insidedynamic-wrapper:
    # Используем готовый образ FreeSWITCH
    image: ghcr.io/patrickbaus/freeswitch-docker:latest

    container_name: insidedynamic-wrapper

    # Coolify Labels for HTTPS (port 443)
    labels:
      - coolify.managed=true
      - coolify.proxy.port=8888

    # Run provision and start (using /bin/sh for Alpine compatibility)
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e

        # Enable verbose mode if DEBUG=true
        if [ "$DEBUG" = "true" ]; then
          set -x
        fi

        # Download VERSION file
        WRAPPER_VERSION=$$(wget -qO- https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/VERSION 2>/dev/null || echo "dev")
        GIT_BRANCH="main"

        # Show banner
        echo ""
        echo "================================================================================"
        if [ -n "$CLIENT_NAME" ]; then
          echo "  InsideDynamic Wrapper v$$WRAPPER_VERSION - ($LICENSE_KEY) für $CLIENT_NAME"
        else
          echo "  InsideDynamic Wrapper v$$WRAPPER_VERSION - ($LICENSE_KEY)"
        fi
        echo "================================================================================"
        echo "  https://github.com/insidedynamic-de/sip_wrapper"
        echo "  (c) 2025 InsideDynamic GmbH - Mannheim, Germany"
        echo "================================================================================"
        echo ""

        # Validate ENV
        echo "[STEP 1/9] Validating environment variables..."
        if [ -z "$FS_DOMAIN" ] || [ -z "$EXTERNAL_SIP_IP" ] || [ -z "$EXTERNAL_RTP_IP" ]; then
          echo "ERROR: Missing required environment variables!"
          echo "Required: FS_DOMAIN, EXTERNAL_SIP_IP, EXTERNAL_RTP_IP"
          exit 1
        fi

        # Auto-detect IP if placeholder
        if [ "$EXTERNAL_SIP_IP" = "your-server-ip" ] || [ "$EXTERNAL_RTP_IP" = "your-server-ip" ]; then
          echo "Auto-detecting public IP..."
          DETECTED_IP=$$(wget -qO- --timeout=5 ifconfig.me 2>/dev/null || wget -qO- --timeout=5 ipinfo.io/ip 2>/dev/null || echo "")
          if [ -n "$$DETECTED_IP" ]; then
            echo "✓ Auto-detected IP: $$DETECTED_IP"
            export EXTERNAL_SIP_IP="$$DETECTED_IP"
            export EXTERNAL_RTP_IP="$$DETECTED_IP"
          else
            echo "ERROR: Could not auto-detect IP"
            exit 1
          fi
        fi

        echo "✓ Environment validated"
        echo "  EXTERNAL_SIP_IP: $EXTERNAL_SIP_IP"
        echo "  EXTERNAL_RTP_IP: $EXTERNAL_RTP_IP"

        # Check if FreeSWITCH is installed
        echo ""
        echo "[STEP 2/9] Checking FreeSWITCH installation..."
        if [ -x /usr/bin/freeswitch ]; then
          echo "✓ FreeSWITCH found"
        else
          echo "ERROR: FreeSWITCH not found in this image!"
          exit 1
        fi

        # Clean default config
        echo ""
        echo "[STEP 3/9] Preparing configuration..."
        if [ -d /etc/freeswitch ]; then
          find /etc/freeswitch/dialplan -type f -name "*.xml" -delete 2>/dev/null || true
          find /etc/freeswitch/directory -type f -name "*.xml" -delete 2>/dev/null || true
          rm -f /etc/freeswitch/sip_profiles/*.xml 2>/dev/null || true
          mkdir -p /etc/freeswitch/dialplan/default /etc/freeswitch/dialplan/public
          mkdir -p /etc/freeswitch/directory/default
          mkdir -p /etc/freeswitch/sip_profiles/internal /etc/freeswitch/sip_profiles/external
          echo "✓ Config directories prepared"
        fi

        # Create log directories
        echo ""
        echo "[STEP 4/9] Setting up logging..."
        mkdir -p /var/log/freeswitch
        chmod 755 /var/log/freeswitch
        echo "✓ Log directory ready: /var/log/freeswitch"

        # Install bash, python, jq and flask (needed for provision script and admin portal)
        echo ""
        echo "[STEP 5/9] Installing dependencies..."
        apk add --no-cache bash python3 py3-flask py3-gunicorn jq >/dev/null 2>&1 || {
          echo "Trying with apt-get..."
          apt-get update -qq && apt-get install -y -qq bash python3 python3-pip python3-venv jq || {
            echo "ERROR: Cannot install dependencies"
            exit 1
          }
        }

        # Create /bin/bash symlink if it doesn't exist
        if [ ! -e /bin/bash ] && [ -x /usr/bin/bash ]; then
          ln -sf /usr/bin/bash /bin/bash
        fi
        echo "✓ Dependencies installed"

        # Download and run provision
        echo ""
        echo "[STEP 6/9] Running provision script..."
        wget --no-cache -qO /tmp/provision.sh https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/provision.sh
        chmod +x /tmp/provision.sh

        if [ "$DEBUG" = "true" ]; then
          /bin/bash -x /tmp/provision.sh 2>&1 || { echo "ERROR: Provision failed"; exit 1; }
        else
          /bin/bash /tmp/provision.sh || { echo "ERROR: Provision failed"; exit 1; }
        fi
        echo "✓ Provision completed"

        # Install Admin Portal
        echo ""
        echo "[STEP 7/9] Installing Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ]; then
          mkdir -p /opt/admin/templates
          mkdir -p /opt/admin/static/css
          mkdir -p /opt/admin/static/js
          mkdir -p /opt/admin/static/vendor/bootstrap
          mkdir -p /opt/admin/static/vendor/bootstrap-icons
          mkdir -p /opt/admin/lang

          ADMIN_BASE="https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin"

          # Download VERSION file for admin portal
          mkdir -p /app
          echo "$$WRAPPER_VERSION" > /app/VERSION

          # Download admin Python files
          wget --no-cache -qO /opt/admin/app.py $$ADMIN_BASE/app.py
          wget --no-cache -qO /opt/admin/config_store.py $$ADMIN_BASE/config_store.py
          wget --no-cache -qO /opt/admin/requirements.txt $$ADMIN_BASE/requirements.txt

          # Download templates
          wget --no-cache -qO /opt/admin/templates/base.html $$ADMIN_BASE/templates/base.html
          wget --no-cache -qO /opt/admin/templates/login.html $$ADMIN_BASE/templates/login.html
          wget --no-cache -qO /opt/admin/templates/dashboard.html $$ADMIN_BASE/templates/dashboard.html
          wget --no-cache -qO /opt/admin/templates/manage.html $$ADMIN_BASE/templates/manage.html
          wget --no-cache -qO /opt/admin/templates/logs.html $$ADMIN_BASE/templates/logs.html
          wget --no-cache -qO /opt/admin/templates/security.html $$ADMIN_BASE/templates/security.html
          wget --no-cache -qO /opt/admin/templates/profile.html $$ADMIN_BASE/templates/profile.html

          # Download static CSS
          wget --no-cache -qO /opt/admin/static/css/admin.css $$ADMIN_BASE/static/css/admin.css

          # Download static JS
          wget --no-cache -qO /opt/admin/static/js/admin.js $$ADMIN_BASE/static/js/admin.js
          wget --no-cache -qO /opt/admin/static/js/manage.js $$ADMIN_BASE/static/js/manage.js
          wget --no-cache -qO /opt/admin/static/js/security.js $$ADMIN_BASE/static/js/security.js

          # Download language files
          wget --no-cache -qO /opt/admin/lang/en.json $$ADMIN_BASE/lang/en.json
          wget --no-cache -qO /opt/admin/lang/de.json $$ADMIN_BASE/lang/de.json

          # Download vendor files (Bootstrap)
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap/bootstrap.min.css $$ADMIN_BASE/static/vendor/bootstrap/bootstrap.min.css
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap/bootstrap.bundle.min.js $$ADMIN_BASE/static/vendor/bootstrap/bootstrap.bundle.min.js
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/bootstrap-icons.min.css $$ADMIN_BASE/static/vendor/bootstrap-icons/bootstrap-icons.min.css

          # Download Bootstrap Icons fonts
          mkdir -p /opt/admin/static/vendor/bootstrap-icons/fonts
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff $$ADMIN_BASE/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff 2>/dev/null || true
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff2 $$ADMIN_BASE/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff2 2>/dev/null || true

          # Install Python dependencies (greenswitch for ESL)
          echo "Installing Python dependencies..."
          apk add --no-cache py3-pip >/dev/null 2>&1 || true
          pip3 install greenswitch --break-system-packages >/dev/null 2>&1 || pip3 install greenswitch >/dev/null 2>&1 || echo "Warning: greenswitch install failed"

          echo "✓ Admin Portal installed"
        else
          echo "✓ Admin Portal skipped (SKIP_ADMIN=true)"
        fi

        # Configure FreeSWITCH logging
        echo ""
        echo "[STEP 8/9] Configuring FreeSWITCH logging..."

        # Create console.conf.xml to enable console logging
        cat > /etc/freeswitch/autoload_configs/console.conf.xml << 'CONSOLEEOF'
        <configuration name="console.conf" description="Console Logger">
          <mappings>
            <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
          </mappings>
          <settings>
            <param name="colorize" value="true"/>
            <param name="loglevel" value="debug"/>
          </settings>
        </configuration>
        CONSOLEEOF

        # Create logfile.conf.xml with proper log settings (including debug)
        cat > /etc/freeswitch/autoload_configs/logfile.conf.xml << 'LOGEOF'
        <configuration name="logfile.conf" description="File Logging">
          <settings>
            <param name="rotate-on-hup" value="true"/>
          </settings>
          <profiles>
            <profile name="default">
              <settings>
                <param name="logfile" value="/var/log/freeswitch/freeswitch.log"/>
                <param name="rollover" value="10485760"/>
                <param name="maximum-rotate" value="10"/>
              </settings>
              <mappings>
                <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
              </mappings>
            </profile>
          </profiles>
        </configuration>
        LOGEOF

        echo "✓ Logging configured (console + file)"

        # Start Admin Portal
        echo ""
        echo "[STEP 9/9] Starting Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ] && [ -f /opt/admin/app.py ]; then
          cd /opt/admin
          python3 app.py &
          ADMIN_PID=$$!
          echo "✓ Admin Portal started on port $ADMIN_PORT (PID: $$ADMIN_PID)"
        else
          echo "✓ Admin Portal not started"
        fi

        # Start FreeSWITCH
        echo ""
        echo "=========================================="
        echo "InsideDynamic Wrapper v$$WRAPPER_VERSION"
        echo "FreeSWITCH is starting..."
        echo ""
        echo "Admin Portal: http://localhost:$ADMIN_PORT"
        if [ -n "$SERVICE_FQDN_ADMIN_8888" ]; then
          echo "Admin Portal (HTTPS): https://$SERVICE_FQDN_ADMIN_8888"
        fi
        echo ""
        echo "Log files: /var/log/freeswitch/"
        echo "  - freeswitch.log (main log)"
        echo "  - Use SIP Trace button for SIP debug"
        echo "=========================================="

        # Start FreeSWITCH in background
        /usr/bin/freeswitch -nonat -nf -nc -conf /etc/freeswitch -log /var/log/freeswitch -db /var/lib/freeswitch/db &
        FS_PID=$$!

        # Wait for FreeSWITCH to start (ESL port 8021)
        echo "Waiting for FreeSWITCH to start..."
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if nc -z 127.0.0.1 8021 2>/dev/null; then
            echo "✓ FreeSWITCH ESL ready"
            break
          fi
          sleep 1
        done

        # Set log level via ESL using Python
        sleep 2
        python3 -c "
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
    s.connect(('127.0.0.1', 8021))
    s.recv(1024)  # auth/request
    s.send(b'auth ClueCon\n\n')
    s.recv(1024)  # +OK
    s.send(b'api fsctl loglevel 7\n\n')  # DEBUG
    s.recv(1024)
    s.send(b'api sofia loglevel all 7\n\n')  # Sofia debug
    s.recv(1024)
    print('Log level set to DEBUG (7)')
except Exception as e:
    print(f'ESL setup: {e}')
finally:
    s.close()
" 2>/dev/null || echo "Log level will be set from Admin Panel"

        echo ""
        echo "=========================================="
        echo "FreeSWITCH started (PID: $$FS_PID)"
        echo "=========================================="

        # Wait for FreeSWITCH process
        wait $$FS_PID

    environment:
      # LICENSE
      LICENSE_KEY: ${LICENSE_KEY:-UNLICENSED}
      CLIENT_NAME: ${CLIENT_NAME:-}

      # REQUIRED
      FS_DOMAIN: ${FS_DOMAIN}
      EXTERNAL_SIP_IP: ${EXTERNAL_SIP_IP}
      EXTERNAL_RTP_IP: ${EXTERNAL_RTP_IP}
      USERS: ${USERS:-}
      GATEWAYS: ${GATEWAYS:-}

      # ROUTING
      DEFAULT_GATEWAY: ${DEFAULT_GATEWAY:-}
      DEFAULT_EXTENSION: ${DEFAULT_EXTENSION:-}
      OUTBOUND_ROUTES: ${OUTBOUND_ROUTES:-}
      OUTBOUND_USER_ROUTES: ${OUTBOUND_USER_ROUTES:-}
      INBOUND_ROUTES: ${INBOUND_ROUTES:-}
      DEFAULT_COUNTRY_CODE: ${DEFAULT_COUNTRY_CODE:-49}
      OUTBOUND_CALLER_ID: ${OUTBOUND_CALLER_ID:-}

      # OPTIONAL
      ACL_USERS: ${ACL_USERS:-}
      INTERNAL_SIP_PORT: ${INTERNAL_SIP_PORT:-5060}
      EXTERNAL_SIP_PORT: ${EXTERNAL_SIP_PORT:-5080}
      RTP_START_PORT: ${RTP_START_PORT:-16384}
      RTP_END_PORT: ${RTP_END_PORT:-32768}
      CODEC_PREFS: ${CODEC_PREFS:-PCMU,PCMA,G729,opus}
      OUTBOUND_CODEC_PREFS: ${OUTBOUND_CODEC_PREFS:-}
      SIP_USER_AGENT: ${SIP_USER_AGENT:-InsideDynamic-Wrapper}
      SIP_DEBUG: ${SIP_DEBUG:-0}
      SIP_TRACE: ${SIP_TRACE:-no}

      # ADMIN PORTAL
      ADMIN_PORT: ${ADMIN_PORT:-8888}
      ADMIN_USER: ${ADMIN_USER:-admin}
      ADMIN_PASS: ${ADMIN_PASS:-admin}
      ADMIN_SECRET: ${ADMIN_SECRET:-insidedynamic-wrapper-secret}
      SKIP_ADMIN: ${SKIP_ADMIN:-false}
      SERVICE_FQDN_ADMIN_8888: ${SERVICE_FQDN_ADMIN_8888:-}

      # ADMIN ESL CONNECTION (FreeSWITCH Event Socket)
      FS_HOST: ${FS_HOST:-127.0.0.1}
      FS_PORT: ${FS_PORT:-8021}
      FS_PASS: ${FS_PASS:-ClueCon}
      FS_ALLOWED_IPS: ${FS_ALLOWED_IPS:-0.0.0.0}
      FS_LOGLEVEL: ${FS_LOGLEVEL:-4}

      # CONFIG STORAGE
      CONFIG_FILE: ${CONFIG_FILE:-/var/lib/freeswitch/wrapper_config.json}

      # DEBUG
      DEBUG: ${DEBUG:-false}

    network_mode: host
    restart: unless-stopped

    volumes:
      # Config storage (persistent)
      - wrapper_config:/var/lib/freeswitch
      # Backups
      - freeswitch_backups:/var/backups/freeswitch
      # FreeSWITCH logs (for admin panel log viewer)
      - freeswitch_logs:/var/log/freeswitch

    healthcheck:
      test: ["CMD", "sh", "-c", "pidof freeswitch || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

volumes:
  wrapper_config:
    driver: local
  freeswitch_backups:
    driver: local
  freeswitch_logs:
    driver: local

################################################################################
# ПРЕИМУЩЕСТВА ЭТОЙ ВЕРСИИ:
################################################################################
# ✅ Не нужно скачивать GPG ключи
# ✅ Не нужно устанавливать пакеты из SignalWire репозитория
# ✅ Быстрый запуск (образ уже скомпилирован)
# ✅ Меньше точек отказа
# ✅ Работает даже если files.freeswitch.org недоступен
# ✅ Admin Portal на порту 8888
# ✅ Логи FreeSWITCH сохраняются в volume
# ✅ i18n поддержка (EN/DE)
#
# ИСПОЛЬЗОВАНИЕ В COOLIFY:
# 1. Docker Compose file: docker-compose.coolify-prebuilt.yml
# 2. Установите ENV переменные
# 3. Deploy
#
# ADMIN PORTAL (HTTPS через Coolify):
# 1. Service Name: insidedynamic-wrapper
# 2. В Coolify: Service -> Proxy -> Port: 8888
# 3. Добавьте домен (например: admin.example.com)
# 4. URL: https://admin.example.com (port 443 автоматически)
# 5. Login: admin / admin (или ADMIN_USER / ADMIN_PASS)
#
# ЛОГИ:
# - FreeSWITCH логи: /var/log/freeswitch/freeswitch.log
# - Admin Portal: Logs страница с SIP Trace и Debug кнопками
# - FS_LOGLEVEL: 0-7 (0=console, 7=debug)
#
# Документация: https://insidedynamic.de/wrapper
################################################################################
