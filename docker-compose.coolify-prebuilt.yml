################################################################################
# FreeSWITCH for Coolify - Pre-built Image Version
# Использует готовый Docker образ вместо установки из репозитория
#
# ИСПОЛЬЗУЙТЕ ЭТУ ВЕРСИЮ ЕСЛИ:
# - Проблемы с загрузкой GPG ключа SignalWire
# - Firewall блокирует доступ к files.freeswitch.org
# - Нужен быстрый запуск без компиляции
################################################################################

version: '3.9'

services:
  freeswitch:
    # Используем готовый образ FreeSWITCH
    # Alternative: ghcr.io/patrickbaus/freeswitch-docker:latest
    image: ghcr.io/patrickbaus/freeswitch-docker:latest

    container_name: freeswitch

    # Run provision and start (using /bin/sh for Alpine compatibility)
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e

        # Enable verbose mode if DEBUG=true
        if [ "$DEBUG" = "true" ]; then
          set -x
          echo "=========================================="
          echo "FreeSWITCH Coolify - Pre-built Image (DEBUG MODE)"
          echo "Start time: $$(date)"
          echo "=========================================="
        else
          echo "=========================================="
          echo "FreeSWITCH Coolify - Pre-built Image"
          echo "Start time: $$(date)"
          echo "=========================================="
        fi

        # Validate ENV
        echo "[STEP 1/6] Validating environment variables..."
        if [ -z "$FS_DOMAIN" ] || [ -z "$EXTERNAL_SIP_IP" ] || [ -z "$EXTERNAL_RTP_IP" ] || [ -z "$USERS" ] || [ -z "$GATEWAYS" ]; then
          echo "ERROR: Missing required environment variables!"
          exit 1
        fi

        # Auto-detect IP if placeholder
        if [ "$EXTERNAL_SIP_IP" = "your-server-ip" ] || [ "$EXTERNAL_RTP_IP" = "your-server-ip" ]; then
          echo "Auto-detecting public IP..."
          DETECTED_IP=$$(wget -qO- --timeout=5 ifconfig.me 2>/dev/null || wget -qO- --timeout=5 ipinfo.io/ip 2>/dev/null || echo "")
          if [ -n "$$DETECTED_IP" ]; then
            echo "✓ Auto-detected IP: $$DETECTED_IP"
            export EXTERNAL_SIP_IP="$$DETECTED_IP"
            export EXTERNAL_RTP_IP="$$DETECTED_IP"
          else
            echo "ERROR: Could not auto-detect IP"
            exit 1
          fi
        fi

        echo "✓ Environment validated"
        echo "  EXTERNAL_SIP_IP: $$EXTERNAL_SIP_IP"
        echo "  EXTERNAL_RTP_IP: $$EXTERNAL_RTP_IP"

        # Check if FreeSWITCH is installed
        echo ""
        echo "[STEP 2/6] Checking FreeSWITCH installation..."
        if [ -x /usr/bin/freeswitch ]; then
          echo "✓ FreeSWITCH found"
        else
          echo "ERROR: FreeSWITCH not found in this image!"
          echo "Image: ghcr.io/patrickbaus/freeswitch-docker:latest"
          exit 1
        fi

        # Clean default config
        echo ""
        echo "[STEP 3/6] Preparing configuration..."
        if [ -d /etc/freeswitch ]; then
          find /etc/freeswitch/dialplan -type f -name "*.xml" -delete 2>/dev/null || true
          find /etc/freeswitch/directory -type f -name "*.xml" -delete 2>/dev/null || true
          rm -f /etc/freeswitch/sip_profiles/*.xml 2>/dev/null || true
          mkdir -p /etc/freeswitch/dialplan/default /etc/freeswitch/dialplan/public
          mkdir -p /etc/freeswitch/directory/default
          mkdir -p /etc/freeswitch/sip_profiles/internal /etc/freeswitch/sip_profiles/external
          echo "✓ Config directories prepared"
        fi

        # Install bash (needed for provision script)
        echo ""
        echo "[STEP 4/6] Installing bash..."
        apk add --no-cache bash >/dev/null 2>&1 || {
          echo "ERROR: Failed to install bash"
          echo "Trying with apt-get..."
          apt-get update -qq && apt-get install -y -qq bash || {
            echo "ERROR: Cannot install bash on this system"
            exit 1
          }
        }

        # Create /bin/bash symlink if it doesn't exist (Alpine installs to /usr/bin/bash)
        if [ ! -e /bin/bash ] && [ -x /usr/bin/bash ]; then
          ln -sf /usr/bin/bash /bin/bash
          echo "✓ Created /bin/bash symlink"
        fi

        echo "✓ Bash installed"

        # Download and run provision
        echo ""
        echo "[STEP 5/6] Running provision script..."
        wget --no-cache -qO /tmp/provision.sh https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/provision.sh
        chmod +x /tmp/provision.sh

        # Run with verbose mode if DEBUG=true
        if [ "$DEBUG" = "true" ]; then
          echo "Running provision.sh with DEBUG mode..."
          /bin/bash -x /tmp/provision.sh 2>&1 || {
            EXIT_CODE=$$?
            echo ""
            echo "ERROR: Provision failed with exit code $$EXIT_CODE"
            exit 1
          }
        else
          /bin/bash /tmp/provision.sh || {
            EXIT_CODE=$$?
            echo ""
            echo "ERROR: Provision failed with exit code $$EXIT_CODE"
            echo "Set DEBUG=true in environment to see detailed output"
            exit 1
          }
        fi
        echo "✓ Provision completed"

        # Start FreeSWITCH
        echo ""
        echo "[STEP 6/6] Starting FreeSWITCH..."
        echo "=========================================="
        echo "FreeSWITCH is starting..."
        echo "=========================================="
        exec /usr/bin/freeswitch -nonat -nf -nc

    environment:
      # REQUIRED
      FS_DOMAIN: ${FS_DOMAIN}
      EXTERNAL_SIP_IP: ${EXTERNAL_SIP_IP}
      EXTERNAL_RTP_IP: ${EXTERNAL_RTP_IP}
      USERS: ${USERS}
      GATEWAYS: ${GATEWAYS}

      # ROUTING
      DEFAULT_GATEWAY: ${DEFAULT_GATEWAY:-}
      DEFAULT_EXTENSION: ${DEFAULT_EXTENSION:-}
      OUTBOUND_ROUTES: ${OUTBOUND_ROUTES:-}
      INBOUND_ROUTES: ${INBOUND_ROUTES:-}

      # OPTIONAL
      ACL_USERS: ${ACL_USERS:-}
      INTERNAL_SIP_PORT: ${INTERNAL_SIP_PORT:-5060}
      EXTERNAL_SIP_PORT: ${EXTERNAL_SIP_PORT:-5080}
      RTP_START_PORT: ${RTP_START_PORT:-16384}
      RTP_END_PORT: ${RTP_END_PORT:-32768}
      CODEC_PREFS: ${CODEC_PREFS:-PCMU,PCMA,G729,opus}
      SIP_DEBUG: ${SIP_DEBUG:-0}
      SIP_TRACE: ${SIP_TRACE:-no}

      # DEBUG
      DEBUG: ${DEBUG:-false}

    network_mode: host
    restart: unless-stopped

    volumes:
      - freeswitch_backups:/var/backups/freeswitch

    healthcheck:
      test: ["CMD", "sh", "-c", "pgrep -x freeswitch > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

volumes:
  freeswitch_backups:
    driver: local

################################################################################
# ПРЕИМУЩЕСТВА ЭТОЙ ВЕРСИИ:
################################################################################
# ✅ Не нужно скачивать GPG ключи
# ✅ Не нужно устанавливать пакеты из SignalWire репозитория
# ✅ Быстрый запуск (образ уже скомпилирован)
# ✅ Меньше точек отказа
# ✅ Работает даже если files.freeswitch.org недоступен
#
# ИСПОЛЬЗОВАНИЕ В COOLIFY:
# 1. Docker Compose file: docker-compose.coolify-prebuilt.yml
# 2. Установите ENV переменные
# 3. Deploy
################################################################################
