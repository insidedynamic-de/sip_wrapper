################################################################################
# InsideDynamic Wrapper for Coolify - Pre-built Image Version
# Использует готовый Docker образ вместо установки из репозитория
#
# ИСПОЛЬЗУЙТЕ ЭТУ ВЕРСИЮ ЕСЛИ:
# - Проблемы с загрузкой GPG ключа SignalWire
# - Firewall блокирует доступ к files.freeswitch.org
# - Нужен быстрый запуск без компиляции
#
# COOLIFY HTTPS (Port 443):
# 1. В Coolify настройте Service -> Proxy -> Port: 8888
# 2. Добавьте домен в Coolify (например: admin.example.com)
# 3. Coolify автоматически выпустит SSL сертификат
# 4. Admin Portal будет доступен: https://admin.example.com
################################################################################

version: '3.9'

services:
  insidedynamic-wrapper:
    # Используем готовый образ FreeSWITCH
    image: ghcr.io/patrickbaus/freeswitch-docker:latest

    container_name: insidedynamic-wrapper

    # Coolify Labels for HTTPS (port 443)
    labels:
      - coolify.managed=true
      - coolify.proxy.port=8888

    # Run provision and start (using /bin/sh for Alpine compatibility)
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e

        # Enable verbose mode if DEBUG=true
        if [ "$DEBUG" = "true" ]; then
          set -x
        fi

        # Download VERSION file
        WRAPPER_VERSION=$$(wget -qO- https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/VERSION 2>/dev/null || echo "dev")
        GIT_BRANCH="main"

        # Show banner
        echo ""
        echo "================================================================================"
        echo "  InsideDynamic Wrapper v$$WRAPPER_VERSION"
        echo "================================================================================"
        echo "  https://github.com/insidedynamic-de/sip_wrapper"
        echo "  (c) 2025 InsideDynamic GmbH - Mannheim, Germany"
        echo "================================================================================"
        echo ""

        # Validate ENV
        echo "[STEP 1/9] Validating environment variables..."
        if [ -z "$FS_DOMAIN" ] || [ -z "$EXTERNAL_SIP_IP" ] || [ -z "$EXTERNAL_RTP_IP" ]; then
          echo "ERROR: Missing required environment variables!"
          echo "Required: FS_DOMAIN, EXTERNAL_SIP_IP, EXTERNAL_RTP_IP"
          exit 1
        fi

        # Auto-detect IP if placeholder
        if [ "$EXTERNAL_SIP_IP" = "your-server-ip" ] || [ "$EXTERNAL_RTP_IP" = "your-server-ip" ]; then
          echo "Auto-detecting public IP..."
          DETECTED_IP=$$(wget -qO- --timeout=5 ifconfig.me 2>/dev/null || wget -qO- --timeout=5 ipinfo.io/ip 2>/dev/null || echo "")
          if [ -n "$$DETECTED_IP" ]; then
            echo "✓ Auto-detected IP: $$DETECTED_IP"
            export EXTERNAL_SIP_IP="$$DETECTED_IP"
            export EXTERNAL_RTP_IP="$$DETECTED_IP"
          else
            echo "ERROR: Could not auto-detect IP"
            exit 1
          fi
        fi

        echo "✓ Environment validated"
        echo "  EXTERNAL_SIP_IP: $EXTERNAL_SIP_IP"
        echo "  EXTERNAL_RTP_IP: $EXTERNAL_RTP_IP"

        # Check if FreeSWITCH is installed
        echo ""
        echo "[STEP 2/9] Checking FreeSWITCH installation..."
        if [ -x /usr/bin/freeswitch ]; then
          echo "✓ FreeSWITCH found"
        else
          echo "ERROR: FreeSWITCH not found in this image!"
          exit 1
        fi

        # Clean default config
        echo ""
        echo "[STEP 3/9] Preparing configuration..."
        if [ -d /etc/freeswitch ]; then
          find /etc/freeswitch/dialplan -type f -name "*.xml" -delete 2>/dev/null || true
          find /etc/freeswitch/directory -type f -name "*.xml" -delete 2>/dev/null || true
          rm -f /etc/freeswitch/sip_profiles/*.xml 2>/dev/null || true
          mkdir -p /etc/freeswitch/dialplan/default /etc/freeswitch/dialplan/public
          mkdir -p /etc/freeswitch/directory/default
          mkdir -p /etc/freeswitch/sip_profiles/internal /etc/freeswitch/sip_profiles/external
          echo "✓ Config directories prepared"
        fi

        # Create log directories
        echo ""
        echo "[STEP 4/9] Setting up logging..."
        mkdir -p /var/log/freeswitch
        chmod 755 /var/log/freeswitch
        echo "✓ Log directory ready: /var/log/freeswitch"

        # Install bash, python, jq and flask (needed for provision script and admin portal)
        echo ""
        echo "[STEP 5/9] Installing dependencies..."
        apk add --no-cache bash python3 py3-flask py3-gunicorn jq >/dev/null 2>&1 || {
          echo "Trying with apt-get..."
          apt-get update -qq && apt-get install -y -qq bash python3 python3-pip python3-venv jq || {
            echo "ERROR: Cannot install dependencies"
            exit 1
          }
        }

        # Create /bin/bash symlink if it doesn't exist
        if [ ! -e /bin/bash ] && [ -x /usr/bin/bash ]; then
          ln -sf /usr/bin/bash /bin/bash
        fi
        echo "✓ Dependencies installed"

        # Download and run provision
        echo ""
        echo "[STEP 6/9] Running provision script..."
        wget --no-cache -qO /tmp/provision.sh https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/provision.sh
        chmod +x /tmp/provision.sh

        if [ "$DEBUG" = "true" ]; then
          /bin/bash -x /tmp/provision.sh 2>&1 || { echo "ERROR: Provision failed"; exit 1; }
        else
          /bin/bash /tmp/provision.sh || { echo "ERROR: Provision failed"; exit 1; }
        fi
        echo "✓ Provision completed"

        # Install Admin Portal
        echo ""
        echo "[STEP 7/9] Installing Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ]; then
          mkdir -p /opt/admin/templates
          mkdir -p /opt/admin/static/css
          mkdir -p /opt/admin/static/js
          mkdir -p /opt/admin/static/vendor/bootstrap
          mkdir -p /opt/admin/static/vendor/bootstrap-icons
          mkdir -p /opt/admin/lang

          ADMIN_BASE="https://raw.githubusercontent.com/insidedynamic-de/sip_wrapper/main/admin"

          # Download VERSION file for admin portal
          mkdir -p /app
          echo "$$WRAPPER_VERSION" > /app/VERSION

          # Download admin Python files
          wget --no-cache -qO /opt/admin/app.py $$ADMIN_BASE/app.py
          wget --no-cache -qO /opt/admin/config_store.py $$ADMIN_BASE/config_store.py
          wget --no-cache -qO /opt/admin/esl_events.py $$ADMIN_BASE/esl_events.py
          wget --no-cache -qO /opt/admin/requirements.txt $$ADMIN_BASE/requirements.txt

          # Download templates
          wget --no-cache -qO /opt/admin/templates/base.html $$ADMIN_BASE/templates/base.html
          wget --no-cache -qO /opt/admin/templates/login.html $$ADMIN_BASE/templates/login.html
          wget --no-cache -qO /opt/admin/templates/dashboard.html $$ADMIN_BASE/templates/dashboard.html
          wget --no-cache -qO /opt/admin/templates/manage.html $$ADMIN_BASE/templates/manage.html
          wget --no-cache -qO /opt/admin/templates/logs.html $$ADMIN_BASE/templates/logs.html
          wget --no-cache -qO /opt/admin/templates/security.html $$ADMIN_BASE/templates/security.html
          wget --no-cache -qO /opt/admin/templates/profile.html $$ADMIN_BASE/templates/profile.html

          # Download static CSS
          wget --no-cache -qO /opt/admin/static/css/admin.css $$ADMIN_BASE/static/css/admin.css
          wget --no-cache -qO /opt/admin/static/css/login.css $$ADMIN_BASE/static/css/login.css

          # Download static JS
          wget --no-cache -qO /opt/admin/static/js/admin.js $$ADMIN_BASE/static/js/admin.js
          wget --no-cache -qO /opt/admin/static/js/manage.js $$ADMIN_BASE/static/js/manage.js
          wget --no-cache -qO /opt/admin/static/js/security.js $$ADMIN_BASE/static/js/security.js
          wget --no-cache -qO /opt/admin/static/js/login.js $$ADMIN_BASE/static/js/login.js

          # Download language files
          wget --no-cache -qO /opt/admin/lang/en.json $$ADMIN_BASE/lang/en.json
          wget --no-cache -qO /opt/admin/lang/de.json $$ADMIN_BASE/lang/de.json

          # Download vendor files (Bootstrap)
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap/bootstrap.min.css $$ADMIN_BASE/static/vendor/bootstrap/bootstrap.min.css
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap/bootstrap.bundle.min.js $$ADMIN_BASE/static/vendor/bootstrap/bootstrap.bundle.min.js
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/bootstrap-icons.min.css $$ADMIN_BASE/static/vendor/bootstrap-icons/bootstrap-icons.min.css

          # Download Bootstrap Icons fonts
          mkdir -p /opt/admin/static/vendor/bootstrap-icons/fonts
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff $$ADMIN_BASE/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff 2>/dev/null || true
          wget --no-cache -qO /opt/admin/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff2 $$ADMIN_BASE/static/vendor/bootstrap-icons/fonts/bootstrap-icons.woff2 2>/dev/null || true

          # Install Python dependencies (greenswitch for ESL)
          echo "Installing Python dependencies..."
          apk add --no-cache py3-pip >/dev/null 2>&1 || true
          pip3 install greenswitch --break-system-packages >/dev/null 2>&1 || pip3 install greenswitch >/dev/null 2>&1 || echo "Warning: greenswitch install failed"

          echo "✓ Admin Portal installed"
        else
          echo "✓ Admin Portal skipped (SKIP_ADMIN=true)"
        fi

        # Configure FreeSWITCH logging
        echo ""
        echo "[STEP 8/9] Configuring FreeSWITCH logging..."

        # Create console.conf.xml to enable console logging
        cat > /etc/freeswitch/autoload_configs/console.conf.xml << 'CONSOLEEOF'
        <configuration name="console.conf" description="Console Logger">
          <mappings>
            <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
          </mappings>
          <settings>
            <param name="colorize" value="true"/>
            <param name="loglevel" value="debug"/>
          </settings>
        </configuration>
        CONSOLEEOF

        # Create logfile.conf.xml with proper log settings (including debug)
        cat > /etc/freeswitch/autoload_configs/logfile.conf.xml << 'LOGEOF'
        <configuration name="logfile.conf" description="File Logging">
          <settings>
            <param name="rotate-on-hup" value="true"/>
          </settings>
          <profiles>
            <profile name="default">
              <settings>
                <param name="logfile" value="/var/log/freeswitch/freeswitch.log"/>
                <param name="rollover" value="10485760"/>
                <param name="maximum-rotate" value="10"/>
              </settings>
              <mappings>
                <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
              </mappings>
            </profile>
          </profiles>
        </configuration>
        LOGEOF

        echo "✓ Logging configured (console + file)"

        # Create event_socket.conf.xml for API connection
        ESL_ACL="loopback.auto"
        if [ "$API_ACL" = "0.0.0.0" ] || [ -z "$API_ACL" ]; then
          ESL_ACL="any_v4.auto"
        fi
        cat > /etc/freeswitch/autoload_configs/event_socket.conf.xml << ESLEOF
        <configuration name="event_socket.conf" description="Socket Client">
          <settings>
            <param name="nat-map" value="false"/>
            <param name="listen-ip" value="0.0.0.0"/>
            <param name="listen-port" value="${API_PORT:-8021}"/>
            <param name="password" value="${APIKEY:-ClueCon}"/>
            <param name="apply-inbound-acl" value="$$ESL_ACL"/>
          </settings>
        </configuration>
        ESLEOF

        echo "✓ Event Socket configured (port $API_PORT)"

        # Start Admin Portal
        echo ""
        echo "[STEP 9/9] Starting Admin Portal..."
        if [ "$SKIP_ADMIN" != "true" ] && [ -f /opt/admin/app.py ]; then
          cd /opt/admin
          python3 app.py &
          ADMIN_PID=$$!
          echo "✓ Admin Portal started on port $ADMIN_PORT (PID: $$ADMIN_PID)"
        else
          echo "✓ Admin Portal not started"
        fi

        # Start FreeSWITCH
        echo ""
        echo "=========================================="
        echo "InsideDynamic Wrapper v$$WRAPPER_VERSION"
        echo "FreeSWITCH is starting..."
        echo ""
        echo "Admin Portal: http://localhost:$ADMIN_PORT"
        echo "Config: Admin UI → config.json"
        echo "Logs: Admin Portal → ESL Events"
        echo "=========================================="

        # Start FreeSWITCH in background
        /usr/bin/freeswitch -nonat -nf -nc -conf /etc/freeswitch -log /var/log/freeswitch -db /var/lib/freeswitch/db &
        FS_PID=$$!

        # Wait for FreeSWITCH to start (API port)
        echo "Waiting for FreeSWITCH to start..."
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if nc -z 127.0.0.1 ${API_PORT:-8021} 2>/dev/null; then
            echo "✓ FreeSWITCH API ready"
            break
          fi
          sleep 1
        done

        # Set log level via API using Python (write script to temp file to avoid YAML issues)
        sleep 2
        cat > /tmp/esl_setup.py << ESLPYEOF
        import socket
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        try:
            s.connect(('127.0.0.1', ${API_PORT:-8021}))
            s.recv(1024)
            s.send(b'auth ${APIKEY:-ClueCon}\n\n')
            s.recv(1024)
            s.send(b'api fsctl loglevel 7\n\n')
            s.recv(1024)
            s.send(b'api sofia loglevel all 7\n\n')
            s.recv(1024)
            print('Log level set to DEBUG (7)')
        except Exception as e:
            print(f'API setup: {e}')
        finally:
            s.close()
        ESLPYEOF
        python3 /tmp/esl_setup.py 2>/dev/null || echo "Log level will be set from Admin Panel"

        echo ""
        echo "=========================================="
        echo "FreeSWITCH started (PID: $$FS_PID)"
        echo "=========================================="

        # Wait for FreeSWITCH process
        wait $$FS_PID

    environment:
      # REQUIRED - SIP Domain & External IP
      FS_DOMAIN: ${FS_DOMAIN}
      EXTERNAL_SIP_IP: ${EXTERNAL_SIP_IP}
      EXTERNAL_RTP_IP: ${EXTERNAL_RTP_IP}

      # API CONNECTION
      APIKEY: ${APIKEY:-ClueCon}
      API_PORT: ${API_PORT:-8021}
      API_ACL: ${API_ACL:-0.0.0.0}

      # ADMIN PORTAL (default: admin:admin on port 8888)
      ADMIN_PORT: ${ADMIN_PORT:-8888}

      # Everything else is configured via Admin UI → config.json:
      # - Users, Gateways, Routes, Codecs, Caller ID
      # - License (14-day trial, then activation)
      # - SERVICE_FQDN is auto-generated by Coolify

    network_mode: host
    restart: unless-stopped

    volumes:
      # Config storage (persistent)
      - wrapper_config:/var/lib/freeswitch
      # Backups
      - freeswitch_backups:/var/backups/freeswitch
      # FreeSWITCH logs
      - freeswitch_logs:/var/log/freeswitch

    healthcheck:
      test: ["CMD", "sh", "-c", "pidof freeswitch || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

volumes:
  wrapper_config:
    driver: local
  freeswitch_backups:
    driver: local
  freeswitch_logs:
    driver: local

################################################################################
# ENV VARIABLES
################################################################################
# Required: FS_DOMAIN, EXTERNAL_SIP_IP, EXTERNAL_RTP_IP
# API:      APIKEY (default: ClueCon), API_PORT (default: 8021),
#           API_ACL (default: 0.0.0.0 = all, or comma-separated IPs/CIDRs)
# Optional: ADMIN_PORT (default: 8888)
#
# After deploy, configure everything via Admin Portal:
# - Users, Gateways, Routes, Codecs, Caller ID
# - Server Settings, License activation (14-day trial)
#
# COOLIFY:
# 1. Docker Compose: docker-compose.coolify-prebuilt.yml
# 2. Set required ENV variables
# 3. Deploy → Coolify generates SERVICE_FQDN automatically
# 4. Login: admin / admin → Profile to change password
#
# Docs: https://insidedynamic.de/wrapper
################################################################################
